<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© - Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙŠ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/notifications.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            background: #0f172a;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 80px auto 20px;
            width: 95%;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 30px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .chat-header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-messages {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .msg {
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 20px;
            font-size: 0.95rem;
            font-weight: 700;
            line-height: 1.5;
            position: relative;
        }

        .msg.sent {
            align-self: flex-start;
            background: var(--gold);
            color: black;
            border-bottom-right-radius: 5px;
        }

        .msg.received {
            align-self: flex-end;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border-bottom-left-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-input-area {
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            color: white;
            outline: none;
            transition: 0.3s;
        }

        .chat-input:focus {
            border-color: var(--gold);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            background: var(--gold);
            color: black;
            border: none;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: 0.3s;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
    </style>
</head>

<body>

    <nav class="glass-nav">
        <div class="container" style="display: flex; align-items: center; justify-content: space-between;">
            <a href="dashboard.html" class="logo-container" style="text-decoration: none; color: white;">
                <i class="fas fa-chevron-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©
            </a>
            <div id="chat-with-name" style="font-weight: 950; font-size: 1.2rem; color: var(--gold);">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø·Ø¨ÙŠØ©
            </div>
            <div></div>
        </div>
    </nav>

    <div class="chat-container">
        <div class="chat-header">
            <div
                style="width: 50px; height: 50px; border-radius: 15px; background: rgba(197, 160, 33, 0.1); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--gold);">
                <i class="fas fa-user-md" id="header-icon"></i>
            </div>
            <div>
                <h4 id="partner-name" style="font-weight: 900; margin: 0; color: white;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h4>
                <p style="margin: 0; font-size: 0.7rem; color: #10b981; font-weight: 800;">Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù† â€¢ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø´ÙØ±Ø©</p>
            </div>
        </div>

        <div class="chat-messages" id="chat-messages">
            <!-- Messages will appear here -->
        </div>

        <form class="chat-input-area" onsubmit="sendMessage(event)">
            <input type="text" id="msg-input" class="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ©..." required>
            <button type="submit" class="send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/realtime-sync.js"></script>
    <script>
        let bookingId = new URLSearchParams(window.location.search).get('booking_id');
        let currentBooking = null;

        document.addEventListener('DOMContentLoaded', () => {
            if (!Store.user) { window.location.href = 'login.html'; return; }

            const bookings = Store.getData('bookings');
            currentBooking = bookings.find(b => b.id == bookingId);

            if (!currentBooking) {
                alert("Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²");
                window.location.href = 'dashboard.html';
                return;
            }

            // UI Setup
            const isDoctor = Store.user.role === 'DOCTOR';
            document.getElementById('partner-name').innerText = isDoctor ? currentBooking.patientName : currentBooking.doctorName;
            if (isDoctor) document.getElementById('header-icon').className = 'fas fa-user';

            renderMessages();

            // Auto-scroll
            const chatBox = document.getElementById('chat-messages');
            chatBox.scrollTop = chatBox.scrollHeight;

            // Simulation: Receive a response after 3 seconds if first message sent
            setInterval(checkNewMessages, 2000);
        });

        function renderMessages() {
            const allMessages = Store.getData('chat_messages');
            const messages = allMessages.filter(m => m.bookingId == bookingId);
            const container = document.getElementById('chat-messages');

            container.innerHTML = messages.map(m => `
                <div class="msg ${m.senderPhone === Store.user.phone ? 'sent' : 'received'}">
                    ${m.text}
                    <div style="font-size: 0.6rem; opacity: 0.6; text-align: left; margin-top: 5px;">${new Date(m.time).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</div>
                </div>
            `).join('');

            if (messages.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding: 40px; color: #64748b; font-weight:700;">ğŸ¤ ØªÙ… ÙØªØ­ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø¢Ù…Ù†Ø© Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¢Ù†.</div>`;
            }
        }

        function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;

            const allMessages = Store.getData('chat_messages');
            const newMsg = {
                bookingId: bookingId,
                senderPhone: Store.user.phone,
                senderName: Store.user.name,
                text: text,
                time: new Date().toISOString()
            };

            allMessages.push(newMsg);
            Store.setData('chat_messages', allMessages);

            input.value = '';
            renderMessages();

            const chatBox = document.getElementById('chat-messages');
            chatBox.scrollTop = chatBox.scrollHeight;

            // Simple Auto-Response Mockup
            if (Store.user.role !== 'DOCTOR') {
                setTimeout(() => {
                    simulateDoctorResponse();
                }, 3000);
            }
        }

        function simulateDoctorResponse() {
            const allMessages = Store.getData('chat_messages');
            const responses = [
                "Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ Ù„Ù‚Ø¯ Ø§Ø³ØªÙ„Ù…Øª Ø±Ø³Ø§Ù„ØªÙƒ.",
                "ÙŠØ±Ø¬Ù‰ Ø¥Ø­Ø¶Ø§Ø± Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ø¹Ùƒ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±.",
                "Ù‡Ù„ ØªØ´Ø¹Ø± Ø¨Ø£ÙŠ Ø£Ø¹Ø±Ø§Ø¶ Ø£Ø®Ø±Ù‰ Ø­Ø§Ù„ÙŠØ§Ù‹ØŸ",
                "ØªÙ…Ø§Ù…ØŒ Ø³Ø£Ù‚ÙˆÙ… Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ø³ØªÙ…Ø§Ø±ØªÙƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© ÙˆØ§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ø®Ù„Ø§Ù„ Ø¯Ù‚Ø§Ø¦Ù‚."
            ];
            const randomMsg = responses[Math.floor(Math.random() * responses.length)];

            allMessages.push({
                bookingId: bookingId,
                senderPhone: 'DR_SIMULATED',
                senderName: currentBooking.doctorName,
                text: randomMsg,
                time: new Date().toISOString()
            });
            Store.setData('chat_messages', allMessages);
            renderMessages();
            const chatBox = document.getElementById('chat-messages');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function checkNewMessages() {
            renderMessages();
        }
    </script>
</body>

</html>