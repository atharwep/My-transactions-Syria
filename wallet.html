<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ù„ÙƒÙŠØ© - Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙŠ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/notifications.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --gold-main: #D4AF37;
            --gold-light: #F9E076;
            --gold-dark: #AA8C2C;
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --border-rgba: rgba(212, 175, 55, 0.25);
        }

        body {
            background-color: var(--bg-dark);
            color: white;
            font-family: 'Almarai', sans-serif;
            /* Unify font */
            margin: 0;
            overflow-x: hidden;
            background-image:
                radial-gradient(at 0% 0%, rgba(212, 175, 55, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(79, 70, 229, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
        }

        .aura {
            display: none;
            /* Removed for performance and cleaner look */
        }

        .header-section {
            padding: 2rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .back-btn {
            width: 45px;
            height: 45px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--gold-main);
            transform: translateX(5px);
        }

        .royal-title {
            text-align: center;
        }

        .royal-title h1 {
            margin: 0;
            font-weight: 800;
            font-size: 1.6rem;
            color: #fff;
        }

        .royal-title p {
            margin: 2px 0 0;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #94a3b8;
            font-weight: 600;
        }

        .currency-stack {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .currency-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .currency-card.active {
            background: rgba(212, 175, 55, 0.1);
            border-color: var(--gold-main);
            box-shadow: 0 10px 30px -5px rgba(212, 175, 55, 0.15);
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            font-weight: 800;
            transition: transform 0.3s;
            margin-left: 15px;
        }

        .currency-card:hover .card-icon {
            transform: scale(1.1);
        }

        .icon-syp {
            background: rgba(212, 175, 55, 0.1);
            color: var(--gold-main);
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .icon-usd {
            background: rgba(99, 102, 241, 0.1);
            color: #818cf8;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .card-info {
            flex: 1;
        }

        .card-info h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 700;
            color: #e2e8f0;
        }

        .card-info p {
            margin: 2px 0 0;
            font-size: 0.7rem;
            color: #94a3b8;
            font-weight: 400;
        }

        .card-balance h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 800;
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            /* Better for numbers */
        }

        /* Detail Section */
        .detail-view {
            margin: 20px auto;
            max-width: 600px;
            padding: 0 1rem;
            display: none;
        }

        .detail-view.active {
            display: block;
            animation: slideUp 0.5s ease forwards;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .main-balance-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
            border: 1px solid var(--border-rgba);
            border-radius: 32px;
            padding: 40px 20px;
            position: relative;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.4);
            overflow: hidden;
        }

        .main-balance-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, transparent, var(--gold-main), transparent);
            opacity: 0.5;
        }

        .main-balance-card h2 {
            font-size: 3rem;
            font-weight: 800;
            margin: 10px 0;
            letter-spacing: -1px;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            font-family: 'Segoe UI', sans-serif;
        }

        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .p-btn {
            padding: 16px;
            border-radius: 18px;
            border: none;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .btn-fill {
            background: linear-gradient(135deg, var(--gold-main), var(--gold-dark));
            color: #fff;
            box-shadow: 0 4px 15px rgba(197, 160, 33, 0.3);
        }

        .btn-fill:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(197, 160, 33, 0.4);
            filter: brightness(1.1);
        }

        .btn-outline {
            background: rgba(255, 255, 255, 0.03);
            color: #cbd5e1;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--gold-main);
            color: white;
        }

        /* Transactions */
        .history-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }

        .history-title h3 {
            font-size: 1.1rem;
            font-weight: 800;
            color: #fff;
        }

        .tx-item {
            background: rgba(30, 41, 59, 0.4);
            border-radius: 18px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.03);
            transition: 0.3s;
        }

        .tx-item:hover {
            background: rgba(30, 41, 59, 0.8);
            transform: translateX(-3px);
        }

        .tx-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tx-type-plus {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .tx-type-minus {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .tx-info {
            flex: 1;
        }

        .tx-info h5 {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 700;
            color: #f1f5f9;
        }

        .tx-info p {
            margin: 3px 0 0;
            font-size: 0.7rem;
            color: #94a3b8;
        }

        .tx-amount .val {
            font-weight: 800;
            font-size: 1rem;
            font-family: 'Segoe UI', sans-serif;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(15px);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: #1e293b;
            width: 100%;
            max-width: 420px;
            border-radius: 32px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
        }

        .form-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: #cbd5e1;
            margin-bottom: 8px;
            display: block;
            padding: 0 5px;
        }

        .p-input {
            width: 100%;
            background: #0f172a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px;
            color: white;
            font-weight: 600;
            outline: none;
            transition: 0.3s;
            box-sizing: border-box;
            margin-bottom: 20px;
            font-size: 1rem;
        }

        .p-input:focus {
            border-color: var(--gold-main);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .verified-badge {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.2);
            padding: 12px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .btn-close {
            position: absolute;
            top: 25px;
            left: 25px;
            color: #94a3b8;
            cursor: pointer;
            font-size: 1.2rem;
            transition: 0.2s;
        }

        .btn-close:hover {
            color: #fff;
            transform: rotate(90deg);
        }

        @media (min-width: 1024px) {
            .wallet-screen {
                display: grid;
                grid-template-columns: 380px 1fr;
                gap: 40px;
                max-width: 1100px;
                margin: 0 auto;
                padding-top: 40px;
            }

            .currency-stack {
                margin: 0;
                padding: 0;
            }

            .detail-view {
                margin: 0;
                display: block;
            }
        }
    </style>
</head>

<body>
    <div class="aura aura-gold"></div>
    <div class="aura aura-purple"></div>

    <div class="header-section">
        <a href="index.html" class="back-btn"><i class="fas fa-chevron-right"></i></a>
        <div class="royal-title">
            <h1>Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ù„ÙƒÙŠØ©</h1>
            <p>Royal Digital Wallet</p>
        </div>
        <div class="back-btn" onclick="toggleNotifCenter()" style="position: relative;">
            <i class="fas fa-bell" style="color: var(--gold-main);"></i>
            <span id="wallet-badge"
                style="display:none; position:absolute; top:-2px; right:-2px; background:red; width:8px; height:8px; border-radius:50%;"></span>
        </div>
    </div>

    <div class="wallet-screen">
        <div class="currency-stack">
            <div class="currency-card active" onclick="switchCurrency('SYP')">
                <div class="card-icon icon-syp">Ù„.Ø³</div>
                <div class="card-info">
                    <h3>Ø§Ù„Ù„ÙŠØ±Ø© Ø§Ù„Ø³ÙˆØ±ÙŠØ©</h3>
                    <p>Syrian Pound</p>
                </div>
                <div class="card-balance">
                    <h4 id="side-balance-syp" class="skeleton" style="min-width: 60px;">&nbsp;</h4>
                </div>
            </div>

            <div class="currency-card" onclick="switchCurrency('USD')">
                <div class="card-icon icon-usd">$</div>
                <div class="card-info">
                    <h3>Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ</h3>
                    <p>US Dollar</p>
                </div>
                <div class="card-balance">
                    <h4 id="side-balance-usd" class="skeleton" style="min-width: 60px;">&nbsp;</h4>
                </div>
            </div>
        </div>

        <!-- Active View -->
        <div id="detail-syp" class="detail-view active">
            <div class="main-balance-card">
                <p style="font-size: 0.7rem; font-weight: 800; color: #94a3b8; text-transform: uppercase;">Ø±ØµÙŠØ¯ Ø§Ù„Ù„ÙŠØ±Ø©
                    Ø§Ù„Ø³ÙˆØ±ÙŠØ©</p>
                <h2 id="main-balance-syp" class="skeleton" style="display:inline-block; min-width: 150px;">&nbsp;</h2>
                <p style="font-size: 1rem; font-weight: 900; color: #94a3b8;">Ù„ÙŠØ±Ø© Ø³ÙˆØ±ÙŠØ©</p>
            </div>

            <div class="action-grid">
                <button class="p-btn btn-fill" onclick="showTopup('SYP')"><i class="fas fa-plus"></i> ØªØ¹Ø¨Ø¦Ø©</button>
                <button class="p-btn btn-outline" onclick="openTransferModal()"><i class="fas fa-paper-plane"></i>
                    ØªØ­ÙˆÙŠÙ„</button>
                <button class="p-btn btn-outline" style="grid-column: span 2;" onclick="openMyQR()"><i
                        class="fas fa-qrcode"></i> Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ</button>
            </div>

            <div class="history-section">
                <div class="history-title">
                    <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                    <span style="font-size: 0.7rem; font-weight: 800; color: #94a3b8;">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</span>
                </div>
                <div id="tx-list-syp">
                    <div class="skeleton" style="height: 50px; margin-bottom: 10px;"></div>
                    <div class="skeleton" style="height: 50px; margin-bottom: 10px;"></div>
                    <div class="skeleton" style="height: 50px; margin-bottom: 10px;"></div>
                </div>
            </div>
        </div>

        <div id="detail-usd" class="detail-view">
            <div class="main-balance-card">
                <p style="font-size: 0.7rem; font-weight: 800; color: #94a3b8; text-transform: uppercase;">Ø±ØµÙŠØ¯ Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±
                    Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ</p>
                <h2 id="main-balance-usd" class="skeleton" style="display:inline-block; min-width: 150px;">&nbsp;</h2>
                <p style="font-size: 1rem; font-weight: 900; color: #94a3b8;">Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ</p>
            </div>

            <div class="action-grid">
                <button class="p-btn btn-fill" style="background:#3b82f6; color:white;" onclick="showTopup('USD')"><i
                        class="fas fa-plus"></i> ØªØ¹Ø¨Ø¦Ø©</button>
                <button class="p-btn btn-outline" onclick="openTransferModal()"><i class="fas fa-paper-plane"></i>
                    ØªØ­ÙˆÙŠÙ„</button>
                <button class="p-btn btn-outline" style="grid-column: span 2;" onclick="openMyQR()"><i
                        class="fas fa-qrcode"></i> Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ</button>
            </div>

            <div class="history-section">
                <div class="history-title">
                    <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                    <span style="font-size: 0.7rem; font-weight: 800; color: #94a3b8;">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</span>
                </div>
                <div id="tx-list-usd"></div>
            </div>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div class="modal" id="transferModal">
        <div class="modal-content">
            <i class="fas fa-times btn-close" onclick="closeTransferModal()"></i>
            <h3
                style="font-weight: 950; font-size: 1.5rem; margin-bottom: 30px; color: var(--gold-main); text-align: center;">
                ØªØ­ÙˆÙŠÙ„ Ù…Ø§Ù„ÙŠ Ù…Ù„ÙƒÙŠ</h3>

            <form id="transferForm">
                <label class="form-label">Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
                <input type="text" id="receiverPhone" class="p-input" placeholder="09xxxxxxxx" required maxlength="10">

                <div class="verified-badge" id="receiverVerified">
                    <div
                        style="width: 35px; height: 35px; background: var(--gold-main); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #000;">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <p style="font-size: 0.6rem; color: #94a3b8; margin: 0; font-weight: 800;">Ø§Ù„Ù…Ø³ØªÙ„Ù… Ø§Ù„Ù…Ø¹ØªÙ…Ø¯:</p>
                        <p style="font-size: 0.9rem; color: var(--gold-main); margin: 0; font-weight: 950;"
                            id="receiverName">...</p>
                    </div>
                </div>

                <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¨Ø§Ù„Ù€ <span id="transferCurrencyName">Ù„ÙŠØ±Ø©</span></label>
                <div style="position: relative;">
                    <input type="number" id="transferAmount" class="p-input"
                        style="font-size: 2rem; text-align: center; height: 80px;" placeholder="0.00" required>
                    <div style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); font-weight: 900; color: var(--gold-main);"
                        id="transferCurrencySymbol">Ù„.Ø³</div>
                </div>

                <button type="submit" id="btnConfirmTransfer" class="p-btn btn-fill"
                    style="width: 100%; margin-top: 20px; height: 65px; font-size: 1.2rem;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¢Ù†</button>

                <p style="text-align: center; font-size: 0.6rem; color: #94a3b8; margin-top: 20px; line-height: 1.6;">
                    Ø¨Ø¶ØºØ·Ùƒ
                    Ø¹Ù„Ù‰ ØªØ£ÙƒÙŠØ¯ØŒ Ø£Ù†Øª ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø©. Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙˆØ±ÙŠØ© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§.</p>
            </form>
        </div>
    </div>

    <!-- My QR Modal -->
    <div class="modal" id="qrModal"
        style="display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px);">
        <div class="modal-content"
            style="background: white; padding: 40px; border-radius: 40px; text-align: center; max-width: 400px; width: 90%;">
            <h3 style="color: black; font-weight: 950; margin-bottom: 5px;">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù„ÙƒÙŠ ğŸ›¡ï¸</h3>
            <p style="color: #64748B; font-size: 0.8rem; margin-bottom: 25px; font-weight: 700;">Ø£Ø¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù„Ù„ÙˆÙƒÙŠÙ„
                Ù„Ù„Ø´Ø­Ù† Ø£Ùˆ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø£Ù…Ø§Ù†</p>
            <div id="myQrcode"
                style="display: inline-block; padding: 15px; background: white; border-radius: 20px; border: 1px solid #EEE;">
            </div>
            <div style="margin-top: 15px; text-align: center;">
                <p id="qr-user-name" style="color: black; font-weight: 950; font-size: 1.3rem; margin-bottom: 5px;">---
                </p>
                <p id="qr-user-phone" style="color: var(--gold-main); font-weight: 800; font-size: 1rem;">---</p>
            </div>
            <button class="p-btn btn-fill" style="width: 100%; margin-top: 25px;"
                onclick="closeQRModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div style="height: 100px;"></div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/realtime-sync.js"></script>
    <script>
        let activeCurrency = 'SYP';

        document.addEventListener('DOMContentLoaded', () => {
            if (!Store.user) {
                window.location.href = 'login.html';
                return;
            }
            renderWallet();

            // Setup Real-time lookup
            const phoneInput = document.getElementById('receiverPhone');
            phoneInput.addEventListener('input', async (e) => {
                const val = e.target.value;
                const badge = document.getElementById('receiverVerified');
                const nameEl = document.getElementById('receiverName');

                if (val.length === 10) {
                    const user = await Auth.findUserByPhone(val);
                    if (user) {
                        nameEl.innerText = user.name;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                } else {
                    badge.style.display = 'none';
                }
            });

            // Setup Transfer Submit
            document.getElementById('transferForm').onsubmit = async (e) => {
                e.preventDefault();
                const phone = document.getElementById('receiverPhone').value;
                const amount = parseFloat(document.getElementById('transferAmount').value);
                const btn = document.getElementById('btnConfirmTransfer');

                if (!amount || amount <= 0) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

                // Get receiver name for confirmation
                const nameEl = document.getElementById('receiverName');
                const receiverName = nameEl.innerText || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

                if (receiverName === "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚..." || receiverName === "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ") {
                    return alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù… Ø£ÙˆÙ„Ø§Ù‹");
                }

                if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­ÙˆÙŠÙ„ ${amount} ${activeCurrency === 'SYP' ? 'Ù„.Ø³' : '$'} Ø¥Ù„Ù‰:\nØ§Ù„Ø§Ø³Ù…: ${receiverName}\nØ§Ù„Ø±Ù‚Ù…: ${phone}`)) {
                    return;
                }

                btn.disabled = true;
                btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...";

                try {
                    const res = await fetch(`${CONFIG.API_BASE_URL}/api/wallet/transfer`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            senderId: Store.user.id,
                            receiverPhone: phone,
                            amount: amount,
                            currency: activeCurrency
                        })
                    });

                    if (res.ok) {
                        Notify.show("Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ­ÙˆÙŠÙ„", `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ ${receiverName}.`, "fas fa-check-double");

                        // Clear Inputs
                        document.getElementById('receiverPhone').value = '';
                        document.getElementById('transferAmount').value = '';
                        document.getElementById('receiverName').innerText = '...';
                        document.getElementById('receiverVerified').style.display = 'none';

                        setTimeout(() => window.location.reload(), 3000); // Increased timeout for sound
                    } else {
                        const data = await res.json();
                        alert("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„: " + (data.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
                        // Fallback to local if appropriate
                        if (!res.status || res.status >= 500) performLocalTransfer(phone, amount, activeCurrency, receiverName);
                    }
                } catch (err) {
                    console.error("Connection error during transfer:", err);
                    performLocalTransfer(phone, amount, activeCurrency, receiverName);
                } finally {
                    btn.disabled = false;
                    btn.innerText = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¢Ù†";
                }
            };
        });

        function performLocalTransfer(phone, amount, currency, receiverName) {
            // Local Fallback for Immediate Result
            const decRes = Store.updateUserBalance(Store.user.phone, -amount, currency, `ØªØ­ÙˆÙŠÙ„ ØµØ§Ø¯Ø± Ø¥Ù„Ù‰ ${receiverName}`, "USER");
            if (decRes.success) {
                const incRes = Store.updateUserBalance(phone, amount, currency, `ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ø±Ø¯ Ù…Ù† ${Store.user.name}`, "USER");
                if (incRes.success) {
                    Notify.show("Ù†Ø¬Ø§Ø­ ÙÙˆØ±ÙŠ (Ù…Ø­Ù„ÙŠ) âš¡", `ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ù…Ø³ØªÙ„Ù…: ${receiverName}`, "fas fa-bolt");
                    // Update session user balance
                    Store.user = Store.getUsers().find(u => u.phone === Store.user.phone);
                    localStorage.setItem('wusul_user', JSON.stringify(Store.user));
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    // Refund sender if receiver failed
                    Store.updateUserBalance(Store.user.phone, amount, currency, "Ø§Ø³ØªØ±Ø¯Ø§Ø¯ ÙØ´Ù„ ØªØ­ÙˆÙŠÙ„", "USER");
                    alert("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ: " + incRes.message);
                }
            } else {
                alert("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ: " + decRes.message);
            }
        }

        function switchCurrency(curr) {
            activeCurrency = curr;
            // Cards
            document.querySelectorAll('.currency-card').forEach(c => c.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Details
            document.querySelectorAll('.detail-view').forEach(d => d.classList.remove('active'));
            document.getElementById(`detail-${curr.toLowerCase()}`).classList.add('active');
        }

        async function renderWallet() {
            // Fetch latest balance from server if possible, else use local
            try {
                const res = await fetch(`${CONFIG.API_BASE_URL}/api/wallet/balance/${Store.user.id}`);
                if (res.ok) {
                    const data = await res.json();
                    Store.user.balanceSYP = data.balanceSYP;
                    Store.user.balanceUSD = data.balanceUSD;
                    localStorage.setItem('wusul_user', JSON.stringify(Store.user));
                }
            } catch (e) { }

            const syp = Store.user.balanceSYP || 0;
            const usd = Store.user.balanceUSD || 0;

            document.getElementById('side-balance-syp').innerText = syp.toLocaleString();
            document.getElementById('side-balance-usd').innerText = usd.toLocaleString();
            document.getElementById('main-balance-syp').innerText = syp.toLocaleString();
            document.getElementById('main-balance-usd').innerText = usd.toLocaleString();

            // REMOVE SKELETONS
            document.querySelectorAll('.skeleton').forEach(el => el.classList.remove('skeleton'));

            // Fetch Transactions from API
            try {
                const txRes = await fetch(`${CONFIG.API_BASE_URL}/api/wallet/transactions/${Store.user.id}`);
                if (txRes.ok) {
                    const txs = await txRes.json();
                    renderTxs(txs.filter(t => t.currency === 'SYP'), 'tx-list-syp');
                    renderTxs(txs.filter(t => t.currency === 'USD'), 'tx-list-usd');
                }
            } catch (e) {
                console.error("Tx history load fail");
                // Remove Skeleton list if failed to load
                document.getElementById('tx-list-syp').innerHTML = '<div style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª (Offline)</div>';
            }
        }

        function toggleNotifCenter() {
            const el = document.getElementById('notif-center');
            const isHidden = el.style.display === 'none';
            el.style.display = isHidden ? 'block' : 'none';

            if (isHidden) {
                renderNotificationHistory();
                // Clear badge
                const badge = document.getElementById('wallet-badge');
                if (badge) badge.style.display = 'none';
            }
        }

        function renderNotificationHistory() {
            const list = document.getElementById('notif-list');
            // Mock history for now or get from localStorage if implemented in notifications.js
            const localHist = JSON.parse(localStorage.getItem('notif_history') || '[]');

            if (localHist.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>';
                return;
            }

            list.innerHTML = localHist.map(n => `
                <div class="notif-item">
                    <i class="${n.icon || 'fas fa-bell'}"></i>
                    <div>
                        <h4>${n.title}</h4>
                        <p>${n.message}</p>
                        <span class="notif-time">${new Date(n.timestamp).toLocaleTimeString()}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderTxs(list, elId) {
            const el = document.getElementById(elId);
            if (list.length === 0) {
                el.innerHTML = '<div style="text-align:center; padding:40px; color:#52525B; font-weight:800;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø©</div>';
                return;
            }
            // Using a structured div approach that looks like a table for history
            el.innerHTML = `
                <div style="display: grid; grid-template-columns: 50px 1fr 100px; padding: 10px; border-bottom: 2px solid rgba(255,255,255,0.05); font-size: 0.7rem; font-weight: 800; color: #64748B;">
                    <span></span>
                    <span>Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
                    <span style="text-align: left;">Ø§Ù„Ù…Ø¨Ù„Øº</span>
                </div>
            ` + list.map(tx => `
            <div class="tx-item" style="border: none; margin-bottom: 5px; background: rgba(255,255,255,0.02); display: grid; grid-template-columns: 50px 1fr 100px; align-items: center;">
                <div class="tx-icon ${tx.amount > 0 ? 'tx-type-plus' : 'tx-type-minus'}" style="width: 35px; height: 35px; border-radius: 10px;">
                    <i class="fas ${tx.amount > 0 ? 'fa-arrow-down-left' : 'fa-arrow-up-right'}" style="font-size: 0.8rem;"></i>
                </div>
                <div class="tx-info">
                    <h5 style="font-size: 0.8rem;">${tx.title}</h5>
                    <p style="font-size: 0.6rem;">${new Date(tx.createdAt || tx.date).toLocaleString('ar-SY')}</p>
                </div>
                <div class="tx-amount" style="text-align: left;">
                    <div class="val" style="color:${tx.amount > 0 ? '#00D9A5' : '#EF4444'}; font-size: 0.9rem;">
                        ${tx.amount > 0 ? '+' : ''}${tx.amount.toLocaleString()}
                    </div>
                </div>
            </div>
        `).join('');
        }

        function openTransferModal() {
            document.getElementById('transferCurrencyName').innerText = activeCurrency === 'SYP' ? 'Ù„ÙŠØ±Ø© Ø³ÙˆØ±ÙŠØ©' : 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ';
            document.getElementById('transferCurrencySymbol').innerText = activeCurrency === 'SYP' ? 'Ù„.Ø³' : '$';
            document.getElementById('transferModal').style.display = 'flex';
        }

        function closeTransferModal() {
            document.getElementById('transferModal').style.display = 'none';
        }

        function showTopup(curr) {
            window.location.href = 'wallet-deposit.html';
        }

        let qrGenerated = false;
        function openMyQR() {
            // Security Check
            const savedPin = localStorage.getItem(`wusul_pin_${Store.user.id}`);
            const bioEnabled = localStorage.getItem('wusul_bio_auth') === 'true';

            if (savedPin || bioEnabled) {
                const userPin = prompt("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² PIN Ø£Ùˆ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù‡ÙˆÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:");
                if (userPin !== savedPin) {
                    Notify.show("Ø®Ø·Ø£ Ø£Ù…Ù†ÙŠ", "Ø±Ù…Ø² Ø§Ù„Ù€ PIN ØºÙŠØ± ØµØ­ÙŠØ­! ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯.", "fas fa-shield-slash");
                    return;
                }
            }

            if (!qrGenerated) {
                new QRCode(document.getElementById("myQrcode"), {
                    text: JSON.stringify({
                        id: Store.user.id,
                        phone: Store.user.phone,
                        type: 'WUSUL_USER_WALLET'
                    }),
                    width: 200,
                    height: 200
                });
                qrGenerated = true;
            }

            document.getElementById('qr-user-name').innerText = Store.user.name;
            document.getElementById('qr-user-phone').innerText = Store.user.phone;
            document.getElementById('qrModal').style.display = 'flex';
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }
    </script>
</body>

</html>