<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰ - Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ù„ÙƒÙŠØ©</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/notifications.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            background: #f8fafc;
        }

        .req-card {
            background: white;
            border-radius: 30px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 0, 0, 0.03);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.03);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .action-btns {
            display: flex;
            gap: 10px;
        }

        .btn-accept {
            background: #16a34a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer;
        }

        .btn-reject {
            background: #dc2626;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer;
        }

        .btn-chat {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer;
            text-decoration: none;
        }
    </style>
</head>

<body>

    <nav class="glass-nav">
        <a href="dashboard.html" class="logo-container">
            <div class="logo-box">
                <img src="assets/logo.png" alt="Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙŠ">
            </div>
            <div style="font-weight: 900; font-size: 18px;">Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨</div>
        </a>
        <div id="nav-right"></div>
    </nav>

    <div class="container">
        <h1 style="font-weight: 950; margin-bottom: 30px;">Ø·Ù„Ø¨Ø§Øª Ø­Ø¬Ø² Ø§Ù„Ù…Ø±Ø¶Ù‰ ğŸ¥</h1>

        <div id="requests-list">
            <div style="text-align: center; padding: 50px; color: #94a3b8; font-weight: 800;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/realtime-sync.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (!Store.user || Store.user.role !== 'DOCTOR') {
                // For simulation, let's allow it if we are ADMIN or just skip check
                // window.location.href = 'login.html'; return;
            }
            renderRequests();
        });

        function renderRequests() {
            const allBookings = JSON.parse(localStorage.getItem('wusul_bookings') || '[]');
            // In simulation, we show all pending bookings or filter by doctor ID if we had it
            const requests = allBookings.filter(b => b.status === 'PENDING');
            const container = document.getElementById('requests-list');

            if (requests.length === 0) {
                container.innerHTML = `<div style="text-align: center; padding: 50px; color: #94a3b8; font-weight: 800;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
                return;
            }

            container.innerHTML = requests.map(b => `
                <div class="req-card">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div style="width: 60px; height: 60px; background: #f1f5f9; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #64748B;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <h3 style="font-weight: 900; margin: 0; font-size: 1.1rem;">Ù…Ø±ÙŠØ¶: ${b.patientName || 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</h3>
                            <p style="margin: 0; color: #64748B; font-size: 0.8rem; font-weight: 700;">${b.serviceName} â€¢ ${b.date}</p>
                            <p style="margin: 0; color: #2563eb; font-size: 0.75rem; font-weight: 800;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${b.patientPhone}</p>
                        </div>
                    </div>
                    <div class="action-btns">
                        <button class="btn-accept" onclick="updateStatus(${b.id}, 'ACCEPTED')">Ù‚Ø¨ÙˆÙ„ âœ…</button>
                        <button class="btn-reject" onclick="updateStatus(${b.id}, 'REJECTED')">Ø±ÙØ¶ âŒ</button>
                    </div>
                </div>
            `).join('');

            // Also show accepted bookings to access chat
            const accepted = allBookings.filter(b => b.status === 'ACCEPTED');
            if (accepted.length > 0) {
                container.innerHTML += `<h2 style="margin: 40px 0 20px; font-weight: 950;">Ø·Ù„Ø¨Ø§Øª Ù…Ù‚Ø¨ÙˆÙ„Ø© (Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ØªØ§Ø­Ø©)</h2>`;
                container.innerHTML += accepted.map(b => `
                    <div class="req-card">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="width: 60px; height: 60px; background: #dcfce7; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #16a34a;">
                                <i class="fas fa-check"></i>
                            </div>
                            <div>
                                <h3 style="font-weight: 900; margin: 0; font-size: 1.1rem;">${b.patientName}</h3>
                                <p style="margin: 0; color: #64748B; font-size: 0.8rem; font-weight: 700;">${b.serviceName} â€¢ ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„</p>
                            </div>
                        </div>
                        <a href="chat.html?booking_id=${b.id}" class="btn-chat">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ğŸ’¬</a>
                    </div>
                `).join('');
            }
        }

        async function updateStatus(id, newStatus) {
            try {
                let res;
                if (newStatus === 'ACCEPTED') {
                    res = await Auth.settleBooking(id);
                } else {
                    res = await Auth.rejectBooking(id);
                }

                if (res.success) {
                    Notify.show("Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©", res.message, "fas fa-check-circle");
                    renderRequests();
                } else {
                    Notify.show("Ø®Ø·Ø£", res.message, "fas fa-times-circle");
                }
            } catch (e) {
                console.error(e);
                Notify.show("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨", "fas fa-bug");
            }
        }

        function renderRequests() {
            // Read from Store.getData('bookings') instead of old 'wusul_bookings'
            const allBookings = Store.getData('bookings');
            const requests = allBookings.filter(b => b.status === 'PENDING');
            const container = document.getElementById('requests-list');

            let html = '';

            if (requests.length === 0 && allBookings.filter(b => b.status === 'ACCEPTED').length === 0) {
                container.innerHTML = `<div style="text-align: center; padding: 50px; color: #94a3b8; font-weight: 800;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
                return;
            }

            if (requests.length > 0) {
                html += requests.map(b => `
                    <div class="req-card">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="width: 60px; height: 60px; background: #f1f5f9; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #64748B;">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <h3 style="font-weight: 900; margin: 0; font-size: 1.1rem;">Ù…Ø±ÙŠØ¶: ${b.patientName || 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</h3>
                                <p style="margin: 0; color: #64748B; font-size: 0.8rem; font-weight: 700;">${b.serviceName} â€¢ ${b.time}</p>
                                <p style="margin: 0; color: #2563eb; font-size: 0.75rem; font-weight: 800;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${b.patientPhone}</p>
                            </div>
                        </div>
                        <div class="action-btns">
                            <button class="btn-accept" onclick="updateStatus(${b.id}, 'ACCEPTED')">Ù‚Ø¨ÙˆÙ„ ÙˆØ§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø£ØªØ¹Ø§Ø¨ âœ…</button>
                            <button class="btn-reject" onclick="updateStatus(${b.id}, 'REJECTED')">Ø±ÙØ¶ âŒ</button>
                        </div>
                    </div>
                `).join('');
            }

            const accepted = allBookings.filter(b => b.status === 'ACCEPTED');
            if (accepted.length > 0) {
                html += `<h2 style="margin: 40px 0 20px; font-weight: 950; color: #1e293b;">âœ… Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…Ø¤ÙƒØ¯Ø© (Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§Ø³ØªÙ…Ø§Ø±Ø©)</h2>`;
                html += accepted.map(b => `
                    <div class="req-card">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="width: 60px; height: 60px; background: #dcfce7; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #16a34a;">
                                <i class="fas fa-check-double"></i>
                            </div>
                            <div>
                                <h3 style="font-weight: 900; margin: 0; font-size: 1.1rem;">${b.patientName}</h3>
                                <p style="margin: 0; color: #64748B; font-size: 0.8rem; font-weight: 700;">${b.serviceName} â€¢ Ù…Ø¯ÙÙˆØ¹</p>
                            </div>
                        </div>
                        <div class="action-btns">
                            <a href="emr.html?phone=${b.patientPhone}&booking_id=${b.id}" class="btn-chat" style="background: #10b981;">Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© ğŸ“‹</a>
                            <a href="chat.html?booking_id=${b.id}" class="btn-chat">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ğŸ’¬</a>
                        </div>
                    </div>
                `).join('');
            }

            container.innerHTML = html;
        }
    </script>
</body>

</html>